---
name: user-model-evolve
description: 会話から学習し、user_model.yaml の更新を提案する。自己進化のコア機能。セッション終了時や「進化して」「学習して」で発火。
---

# Evolve Skill 🧬

会話の内容から学習し、User Model の更新を自律的に提案します。

> **設定**: パスは `user-model-core/config.yaml` を参照

## 進化のモード

### Mode 1: 表層学習（従来）
ユーザーの明示的発言から学習

### Mode 2: 深層推論（新規）
行動観察から暗黙のパターンを推測

---

## 自己進化のトリガー

### 明示的トリガー
- 「進化して」「学習して」「更新を提案して」
- 「深く分析して」「仮説を立てて」

### 暗黙的トリガー（検知して提案）
- ユーザーが好み・価値観を明示した
- 特定のアプローチが効果的だった
- ユーザーが繰り返し修正を求めたパターン
- セッションが長く続いた後
- **ユーザーが選択肢を即却下した**（新規）
- **ユーザーの反応が予測と異なった**（新規）

---

## 進化の観点

### 1. stable への追加候補

| 検知パターン | 提案 |
|-------------|------|
| 「〇〇は絶対嫌」 | `anti_goals` に追加 |
| 「〇〇が大事」 | `values` に追加 |
| 「〇〇形式で」（繰り返し） | `formatting.prefer` に追加 |
| 「〇〇は避けて」（繰り返し） | `formatting.avoid` に追加 |

### 2. learning_log への追加候補

| 検知パターン | 提案 |
|-------------|------|
| 「これいい」「効いた」 | `corrections_that_worked` に追加 |
| 同じミスを指摘された | `common_pitfalls` に追加 |

### 3. mutable の更新候補

| 検知パターン | 提案 |
|-------------|------|
| 新しいプロジェクトの話題 | `current_projects` に追加 |
| 「今は〇〇に集中」 | `current_focus_topics` を更新 |

### 4. cognitive_patterns への追加候補（新規）

| 観察 | 推測 → 提案 |
|------|------------|
| 選択肢を常に減点法で評価 | `reasoning_defaults` に追加 |
| 抽象的な提案を即却下 | `attention_biases` に追加 |
| 3つ以上の選択肢で迷う | `cognitive_load_triggers` に追加 |
| 「まず〇〇から」が多い | `decision_heuristics` に追加 |

### 5. hypotheses への追加（新規）

Agent が仮説を立て、検証を待つ：

| 観察 | 仮説（例） |
|------|-----------|
| 具体例を頻繁に求める | 「過去に抽象的な計画で失敗した経験がある」 |
| 即断即決が多い | 「時間的制約を強く感じている」 |
| 修正より再生成を好む | 「完璧主義的傾向がある」 |

---

## 仮説検証ループ 🔄

```
観察 → 仮説生成 → 検証質問 → 更新/棄却
  ↑__________________________|
```

### 1. 行動を観察・記録

```yaml
behavioral_observations:
  - context: "設計案を3つ提示"
    action: "案Cを即却下"
    inferred_reason: "実装詳細が不足？"
    date: "2026-01-23"
```

### 2. 仮説を生成

```yaml
hypotheses:
  - hypothesis: "抽象度が高い提案は信用しない"
    evidence: ["案Cは概念図のみだった", "過去にも詳細を先に聞いた"]
    confidence: 0.6
    status: "pending"
```

### 3. 自然に検証

**悪い例**（直接質問）:
> 「抽象的な提案を嫌いますか？」

**良い例**（文脈内で検証）:
> 「この方向性で進める前に、実装イメージを先に共有しましょうか？」

ユーザーの反応で仮説を更新：
- 「ぜひ」→ confidence 上げる
- 「いや、方向性が先」→ 仮説を修正 or 棄却

### 4. 仮説の昇格

confidence 0.8+ かつ複数回検証 → `cognitive_patterns` に昇格

---

## 出力フォーマット

### 通常モード

```
🧬 進化の提案

今回の会話から以下の学習を検知しました：

【stable への追加】
A. formatting.prefer に「選択肢は記号で」を追加
   理由: 明示的に要望があった

【learning_log への追加】
B. corrections_that_worked に記録
   - context: "選択肢の提示"
   - intervention: "記号で一発選択"
   - outcome: "効率化"

【mutable の更新】
C. current_projects に「User Model 構築」を追加

適用: [A] [B] [C] [全部] [なし]
```

### 深層推論モード（新規）

```
🔬 深層分析

【行動観察】
- 抽象的な案Cを即却下
- 「具体的には？」と3回質問

【仮説】
H1. 抽象度が高い提案を警戒する傾向がある
    evidence: 上記観察
    confidence: 0.6

【検証アプローチ】
次回、段階的に抽象→具体で提示し、反応を観察

記録する？ [Y] [N]
```

---

## 進化のルール

1. **確認必須**: 自動更新はしない。必ず提案→承認
2. **根拠提示**: なぜその学習をしたか説明
3. **可逆性**: 間違った学習は `forget` で削除可能
4. **段階的**: 一度に大量の変更を提案しない
5. **検証優先**: 仮説は検証されるまで `cognitive_patterns` に昇格しない（新規）

---

## confidence スコア

| スコア | 基準 |
|--------|------|
| 0.9+ | ユーザーが明示的に言った |
| 0.7-0.8 | 繰り返しパターンから推測 |
| 0.5-0.6 | 単発の反応から推測 |
| 0.5未満 | 提案しない（仮説として保持は可） |

### 仮説の confidence 調整

| イベント | 調整 |
|----------|------|
| 検証で一致 | +0.1〜0.2 |
| 検証で不一致 | -0.2〜0.3 |
| 反証が見つかった | `status: refuted` |
| 部分的に正しい | `status: refined` + 仮説を修正 |

---

## メタ学習

`evolve` 自体の効果も記録する：
- 提案が採用された → confidence 上げる
- 提案が却下された → パターンを見直す
- **仮説が検証された → 推論パターンを強化**（新規）
- **仮説が外れた → 推論パターンを見直す**（新規）

---

## Deep Analysis との連携 🔬

### いつ deep-analysis を促すか

以下の条件を満たしたら、深層分析を提案：

| 条件 | 閾値 |
|------|------|
| behavioral_observations の件数 | 10件以上 |
| hypotheses の件数 | 5件以上 |
| 前回の deep_analysis からの経過 | 30日以上 |
| ユーザーが「自分について知りたい」と発言 | 即時 |

### 提案フォーマット

```
💡 深層分析の提案

十分な観察データが蓄積されました：
- 行動観察: 15件
- 仮説: 7件
- 前回分析: 45日前7層の深層自己構造分析を実行しますか？
「深層分析して」で開始できます。
```

### データの流れ

```
evolve（日常の学習）
    ↓
behavioral_observations に蓄積
    ↓
hypotheses に仮説を蓄積
    ↓
deep-analysis（定期的な深層分析）
    ↓
deep_self_structure に分析結果を保存
    ↓
cognitive_patterns / stable に確定した洞察を昇格
```

### deep_self_structure からの逆流

deep-analysis で得られた洞察を日常の `evolve` に活用：

1. **Layer 4（感情トリガー）** → 会話中の警告に使用
2. **Layer 3（行動パターン）** → stuck_loops を検知したら介入
3. **Layer 6（内的矛盾）** → say_do_gaps を検知したら確認

### 関連スキル

- `user-model-deep-analysis`: 7層の深層分析を実行
- `agent-memory-remember`: 重要な会話を記憶
- `agent-memory-recall`: 過去の記憶を想起
